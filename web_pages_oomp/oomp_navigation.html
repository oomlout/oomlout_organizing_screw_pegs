{% extends "_layout.html" %}

{% block content %}
<section class="info-card">
  <h2>OOMP Taxonomy Navigation</h2>
  <p>The hierarchy below follows these data fields (in order):</p>
  <ol class="taxonomy-levels">
    {% for field in taxonomy_fields %}
    <li>{{ field | replace("_", " ") | title }}</li>
    {% endfor %}
  </ol>
  <p>
    Tracking <strong>{{ total_parts }}</strong> parts across
    <strong>{{ navigation_tree | count }}</strong> sources.
  </p>
</section>

{% macro render_branch(nodes, level) -%}
<ul class="taxonomy-branch level-{{ level }}">
  {% for node in nodes %}
  <li>
    <details class="taxonomy-node">
      <summary>
        <span class="taxonomy-label">{{ node.label }}</span>
        <span class="taxonomy-count">({{ node.count }})</span>
      </summary>
      {% if node.children %}
        {{ render_branch(node.children, level + 1) }}
      {% endif %}
      {% if node.parts and level >= 2 %}
      <ul class="taxonomy-parts">
        {% for part in node.parts %}
        <li><a href="{{ part.detail_url }}">{{ part.id }}</a></li>
        {% endfor %}
      </ul>
      {% endif %}
    </details>
  </li>
  {% endfor %}
</ul>
{%- endmacro %}

{% for group, section in navigation_tree.items() %}
{% set nodes = section.nodes %}
{% set root_parts = section.root_parts %}
<section class="info-card">
  <h3>{{ group | replace("_", " ") | title }} ({{ group_totals[group] }} parts)</h3>
  {% if root_parts %}
  <ul class="taxonomy-parts taxonomy-root-parts">
    {% for part in root_parts %}
    <li><a href="{{ part.detail_url }}">{{ part.id }}</a></li>
    {% endfor %}
  </ul>
  {% endif %}
  {{ render_branch(nodes, 0) }}
</section>
{% endfor %}

<style>
  .taxonomy-levels {
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem 1rem;
    padding-left: 1.2rem;
    font-size: 0.9rem;
    color: var(--text-muted);
  }

  .taxonomy-levels li {
    background: var(--bg-panel);
    padding: 0.25rem 0.5rem;
    border-radius: 8px;
    border: 1px solid var(--border);
  }

  .taxonomy-branch {
    list-style: none;
    padding-left: 0;
    margin: 0;
  }

  .taxonomy-branch > li {
    margin: 0.3rem 0;
  }

  .taxonomy-node {
    background: var(--bg-panel);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.45rem 0.8rem;
    box-shadow: var(--shadow-panel);
  }

  .taxonomy-node summary {
    cursor: pointer;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: var(--text-primary);
  }

  .taxonomy-node summary::-webkit-details-marker {
    display: none;
  }

  .taxonomy-count {
    color: var(--text-muted);
    font-size: 0.85rem;
    margin-left: 0.5rem;
  }

  .taxonomy-parts {
    list-style: none;
    padding-left: 1.2rem;
    margin: 0.5rem 0 0;
    display: grid;
    gap: 0.25rem;
  }

  .taxonomy-parts a {
    color: var(--accent);
    text-decoration: none;
  }

  .taxonomy-parts a:hover {
    text-decoration: underline;
  }

  .taxonomy-root-parts {
    padding-left: 0;
    margin-top: 0;
  }

  .level-0 {
    padding-left: 0;
  }

  .level-1 {
    padding-left: 1rem;
  }

  .level-2 {
    padding-left: 2rem;
  }

  .level-3,
  .level-4,
  .level-5,
  .level-6,
  .level-7,
  .level-8 {
    padding-left: 2.5rem;
  }
</style>
{% endblock %}
