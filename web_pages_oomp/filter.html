{% extends "_layout.html" %}

{% block content %}
<section class="info-card">
  <h2>Filter Parts</h2>
  <p>
    Start typing to narrow the list by top-level category or part identifier. Each entry combines
    its root folder with the part's YAML <code>id</code>, so matches will include both.
  </p>
  <div class="form-field">
    <input id="part-filter-input" type="search" placeholder="Search by category or id" autocomplete="off" />
  </div>
  <p id="part-filter-result-count">{{ total_parts }} parts available.</p>
</section>

<section class="info-card">
  <h3>Matching Parts</h3>
  <p id="part-filter-summary">
    Displaying the first 0 parts. Add search terms (space-separated) to narrow the list.
  </p>
  <ul id="part-filter-results" class="part-filter-list"></ul>
</section>

<style>
  #part-filter-input {
    font: inherit;
    padding: 0.7rem 0.85rem;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--bg-panel);
    color: var(--text-primary);
    box-shadow: var(--shadow-panel);
  }

  #part-filter-input:focus {
    outline: 2px solid rgba(37, 99, 235, 0.18);
    border-color: var(--accent);
  }

  .part-filter-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 0.75rem;
  }

  .part-filter-item {
    background: var(--bg-panel);
    border: 1px solid var(--border);
    border-radius: 10px;
    box-shadow: var(--shadow-panel);
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .part-filter-item:hover {
    border-color: var(--accent);
    box-shadow: 0 12px 24px -18px rgba(37, 99, 235, 0.45);
  }

  .part-filter-item a {
    display: grid;
    gap: 0.3rem;
    font-weight: 600;
    color: var(--text-primary);
    text-decoration: none;
    padding: 0.75rem 1rem;
  }

  .part-filter-id {
    font-weight: 650;
    font-size: 0.95rem;
    line-height: 1.3;
  }

  .part-filter-meta {
    font-size: 0.8rem;
    color: var(--text-muted);
  }
</style>

<script>
  (function () {
    const entries = {{ part_entries | tojson }};
    const input = document.getElementById("part-filter-input");
    const counter = document.getElementById("part-filter-result-count");
    const summary = document.getElementById("part-filter-summary");
    const list = document.getElementById("part-filter-results");
    const LIMIT = 200;
    const totalParts = entries.length;

    function renderMatches(matches) {
      list.textContent = "";
      const fragment = document.createDocumentFragment();
      matches.forEach((entry) => {
        const li = document.createElement("li");
        li.className = "part-filter-item";

        const link = document.createElement("a");
        link.href = entry.detail_url;

        const idSpan = document.createElement("span");
        idSpan.className = "part-filter-id";
        idSpan.textContent = entry.id;

        const metaSpan = document.createElement("span");
        metaSpan.className = "part-filter-meta";
        const parts = [entry.group, entry.top_category || "unspecified"];
        if (Array.isArray(entry.words) && entry.words.length) {
          parts.push(`BIP-39: ${entry.words.join(" ")}`);
        }
        metaSpan.textContent = parts.join(" Â· ");

        link.appendChild(idSpan);
        link.appendChild(metaSpan);
        li.appendChild(link);
        fragment.appendChild(li);
      });
      list.appendChild(fragment);
    }

    function applyFilter() {
      const query = input.value.trim().toLowerCase();
      const terms = query.split(/\s+/).filter(Boolean);
      let matches = entries;

      if (terms.length > 0) {
        matches = entries.filter((entry) =>
          terms.every((term) => entry.search_blob.includes(term))
        );
      }

      const limited = matches.slice(0, LIMIT);
      renderMatches(limited);

      const matchCount = matches.length;
      const label = matchCount === 1 ? "part" : "parts";
      counter.textContent = `${matchCount} ${label} available.`;

      if (terms.length === 0) {
        if (matchCount > LIMIT) {
          summary.textContent = `Displaying first ${LIMIT} of ${matchCount} parts. Add search terms to refine.`;
        } else {
          summary.textContent = `Displaying all ${matchCount} parts. Add search terms to refine.`;
        }
      } else {
        let message = `${matchCount} ${label} match "${terms.join(" ")}".`;
        if (matchCount > LIMIT) {
          message += ` Showing first ${LIMIT}.`;
        }
        summary.textContent = message;
      }
    }

    input.addEventListener("input", applyFilter);
    applyFilter();
  })();
</script>
{% endblock %}
